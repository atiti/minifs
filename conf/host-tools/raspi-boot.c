/*
 * Create a raspberry-pi kernel boot image
 * (C) Michel Pollet <buserror@gmail.com>
 * 
 * GPL
 */
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>

int main(int argc, const char ** argv)
{
	int i = 1;
	const char *fin, *fout;
	int in = -1, out = -1;
	
	if ((in = open(fin = argv[i++], O_RDONLY)) == -1) {
		perror(fin);
		exit(1);
	}
	if ((out = open(fout = argv[i++], O_WRONLY|O_CREAT, 0644)) == -1) {
		perror(fout);
		exit(1);
	}
	
	uint8_t block[4096];
	
	const uint8_t boot[] = {
		0x06, 0x00, 0x00, 0xea,
		0x00, 0x00, 0xa0, 0xe1,
		0x00, 0x00, 0xa0, 0xe1,
		0x00, 0x00, 0xa0, 0xe1,
		0x00, 0x00, 0xa0, 0xe1,
		0x00, 0x00, 0xa0, 0xe1,
		0x00, 0x00, 0xa0, 0xe1,
		0x00, 0x00, 0xa0, 0xe1,
		0x00, 0x00, 0x00, 0xe3,
		0x42, 0x10, 0xa0, 0xe3,
		0x0c, 0x1c, 0x81, 0xe3,
		0x00, 0x20, 0x9f, 0xe5,
		0x00, 0xf0, 0x9f, 0xe5,
		0x00, 0x01, 0x00, 0x00,
		0x00, 0x80, 0x00, 0x00,
	};
	const uint8_t arg[] = {
		0x05, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x41, 0x54,
		0x01, 0x00, 0x00, 0x00,
		0x00, 0x10, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x04, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x41, 0x54,
		0x00, 0x00, 0x00, 0x80,
		0x00, 0x10, 0x00, 0x00,
		0x00, 0x10, 0x00, 0x00,
		0x00, 0x10, 0x00, 0x00,
	};
	int e;
	ssize_t rd;
	memset(block, 0, sizeof(block));
	memcpy(block + 0x0000, boot, sizeof(boot));
	memcpy(block + 0x0100, arg, sizeof(arg));
	
		
	for (i = 0; i < (32 * 1024) / sizeof(block); i++) {
		e = write(out, block, sizeof(block));
		if (e == -1)
			goto error;
		if (i == 0) // re-erase buffer
			memset(block, 0, sizeof(block));
	}
	do {
		rd = read(in, block, sizeof(block));
		if (rd == -1)
			goto error;
		if (rd > 0) {
			e = write(out, block, rd);
			if (e == -1)
				goto error;
		}
	} while (rd > 0);
	
	close(in); close(out);
	exit(0);
error:
	perror(fout);
	unlink(fout);
	exit(1);
}
